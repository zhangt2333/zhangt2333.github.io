<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 3.9.0"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>Java8-Optional使用心得 - Zhang T&#39;s Blog</title><link rel="icon" href="/images/favicon.svg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><link rel="stylesheet" href="/css/back-to-top.css"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-212316117-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-212316117-1")</script><link rel="stylesheet" href="/css/progressbar.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><link rel="stylesheet" href="/css/style.css"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand is-flex-center"><a class="navbar-item navbar-logo" href="/">TTTT&#39;s Blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a> <a class="navbar-item" href="/archives">归档</a> <a class="navbar-item" href="/categories">分类</a> <a class="navbar-item" href="/tags">标签</a> <a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" title="GitHub" href="https://github.com/zhangt2333"><i class="fab fa-github"></i> </a><a class="navbar-item" target="_blank" title="E-mail" href="mailto:zhangt2333@gmail.com"><i class="fa fa-envelope-open"></i> </a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i> </a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main"><div class="card"><div class="card-content article"><h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal"><i class="fas fa-angle-double-right"></i>Java8-Optional使用心得</h1><div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto"><div class="level-left"><time class="level-item has-text-grey" datetime="2022-10-03T04:00:00.000Z"><i class="far fa-calendar-alt">&nbsp;</i>2022-10-03</time><div class="level-item"><i class="far fa-folder-open has-text-grey"></i>&nbsp; <a class="has-link-grey -link" href="/categories/CS/">CS</a></div><span class="level-item has-text-grey"><i class="far fa-clock"></i>&nbsp; 16 分钟 读完 (大约 2395 个字) </span><span class="level-item has-text-grey" id="busuanzi_container_page_pv"><i class="far fa-eye"></i> <span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><div class="content"><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>NPE（NullPointerException）是很讨人厌的东西，比如它让你在写代码时总担心你不熟悉的 API 返回的是不是一个可空的类型。</p><p>Kotlin 有令人感到兴奋的空安全机制，即引入了 <code>T?</code> 表示类型 <code>T | null</code>，感兴趣可以了解下。</p><p>Java 8 引入了 Optional，似乎可以作为 <code>T?</code> 的一种替代方案，但事实好像并非如此？</p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Optional</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="hljs-comment">//Null指针的封装</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.util.Optional&lt;?&gt; EMPTY = <span class="hljs-keyword">new</span> java.util.Optional&lt;&gt;();</span><br><span class="line">    <span class="hljs-comment">//内部包含的值对象</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> T value;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Optional</span><span class="hljs-params">()</span> </span>;</span><br><span class="line">    <span class="hljs-comment">//返回EMPTY对象</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>&lt;T&gt; java.util.<span class="hljs-function">Optional&lt;T&gt; <span class="hljs-title">empty</span><span class="hljs-params">()</span> </span>;</span><br><span class="line">    <span class="hljs-comment">//构造函数，但是value为null，会报NPE</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Optional</span><span class="hljs-params">(T value)</span></span>;</span><br><span class="line">    <span class="hljs-comment">//静态工厂方法，但是value为null，会报NPE</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; java.util.<span class="hljs-function">Optional&lt;T&gt; <span class="hljs-title">of</span><span class="hljs-params">(T value)</span></span>;</span><br><span class="line">    <span class="hljs-comment">//静态工厂方法，value可以为null</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; java.util.<span class="hljs-function">Optional&lt;T&gt; <span class="hljs-title">ofNullable</span><span class="hljs-params">(T value)</span> </span>;</span><br><span class="line">    <span class="hljs-comment">//获取value，但是value为null，会报NoSuchElementException</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>;</span><br><span class="line">    <span class="hljs-comment">//返回value是否为null</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isPresent</span><span class="hljs-params">()</span></span>;</span><br><span class="line">    <span class="hljs-comment">//如果value不为null，则执行consumer式的函数，为null不做事</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ifPresent</span><span class="hljs-params">(Consumer&lt;? <span class="hljs-keyword">super</span> T&gt; consumer)</span> </span>;</span><br><span class="line">     <span class="hljs-comment">//过滤，如果value不为null，则根据条件过滤，为null不做事</span></span><br><span class="line">    <span class="hljs-keyword">public</span> java.util.<span class="hljs-function">Optional&lt;T&gt; <span class="hljs-title">filter</span><span class="hljs-params">(Predicate&lt;? <span class="hljs-keyword">super</span> T&gt; predicate)</span> </span>;</span><br><span class="line">     <span class="hljs-comment">//转换，在其外面封装Optional，如果value不为null，则map转换，为null不做事</span></span><br><span class="line">    <span class="hljs-keyword">public</span>&lt;U&gt; java.util.<span class="hljs-function">Optional&lt;U&gt; <span class="hljs-title">map</span><span class="hljs-params">(Function&lt;? <span class="hljs-keyword">super</span> T, ? extends U&gt; mapper)</span></span>;</span><br><span class="line">     <span class="hljs-comment">//转换，如果value不为null，则map转换，为null不做事</span></span><br><span class="line">    <span class="hljs-keyword">public</span>&lt;U&gt; java.util.<span class="hljs-function">Optional&lt;U&gt; <span class="hljs-title">flatMap</span><span class="hljs-params">(Function&lt;? <span class="hljs-keyword">super</span> T, java.util.Optional&lt;U&gt;&gt; mapper)</span> </span>;</span><br><span class="line">    <span class="hljs-comment">//value为null时，默认提供other值</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">orElse</span><span class="hljs-params">(T other)</span></span>;</span><br><span class="line">      <span class="hljs-comment">//value为null时，默认提供other值</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">orElseGet</span><span class="hljs-params">(Supplier&lt;? extends T&gt; other)</span></span>;</span><br><span class="line">      <span class="hljs-comment">//value为null时，默认提供other值</span></span><br><span class="line">    <span class="hljs-keyword">public</span> &lt;X extends Throwable&gt; <span class="hljs-function">T <span class="hljs-title">orElseThrow</span><span class="hljs-params">(Supplier&lt;? extends X&gt; exceptionSupplier)</span> </span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关于 Optional 的 Usage，网上很多文章了，这里不赘述</p><h2 id="他人观点"><a href="#他人观点" class="headerlink" title="他人观点"></a>他人观点</h2><p>参与设计 Java 语言的 Oracle 工程师 Brian Goetz 在 <a href="https://stackoverflow.com/questions/26327957/should-java-8-getters-return-optional-type" target="_blank" rel="noopener">Stack Overflow</a> 上说过：</p><ul><li>Optional 不是一个通用的 <code>Maybe</code> 类型（即没有变成类型系统上类似 <code>T?</code> 和 <code>T!</code> 的设计，尽管很多人希望我们这么做）</li><li>我们的目标是提供一个有限的机制，为库方法的返回类型提供一种清晰的表示 No Result 的方式（在某些情况使用 null 极有可能会导致错误）</li><li>我认为 Optional 的设计没有错，尽管它不像很多人希望的那样。</li><li>但确实应该避免过度使用 Optional（我们担心过度使用的风险）</li></ul><p>其他观点：</p><ul><li>Optional 是伴随着 Java8 中函数式编程出现，在 JDK 代码中，Optional 大都用在 Stream 中</li></ul><h2 id="公认事项"><a href="#公认事项" class="headerlink" title="公认事项"></a>公认事项</h2><p>一些使用误区：</p><ul><li><del>包装数组或容器中的类型 <code>public List&lt;Optional&lt;A&gt;&gt; get();</code></del></li><li><del>作为字段</del></li><li><del>作为方法参数 <code>void doSth(Optional&lt;A&gt; a);</code></del></li><li><del>过度用作 getter 的返回值</del></li></ul><p>一些注意事项：</p><ul><li>永远不要用 <code>Optional.get</code>，除非你可以证明它不为空（但是先调用 <code>Optional.isPresent</code> 再调用 <code>Optional.get</code> 明显就是一种过度使用）。可选择用 <code>Optional.orElse</code> 和 <code>Optional.ifPresent</code></li><li>Optional 不能序列化</li></ul><h2 id="个人之言"><a href="#个人之言" class="headerlink" title="个人之言"></a>个人之言</h2><p>以下结合我个人的实际编码经历，来尝试总结一下</p><h3 id="不要为了用而用"><a href="#不要为了用而用" class="headerlink" title="不要为了用而用"></a>不要为了用而用</h3><p>函数式编程有了 Optional，能更写出更流畅的代码逻辑。但不是说我们平时按命令式语言的逻辑写代码时，一定要转成函数式去写（我年轻时候喜欢这样写，是有种炫技的感觉？）</p><p>下面我拿几个真实的例子来循序渐进地说明一下（可以见仁见智地一同分析一下）</p><ul><li>第一种：宁愿别用</li></ul><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 例子1</span></span><br><span class="line">Optional.of(reqDTO)</span><br><span class="line">  .map(ContestSubmissionListReqDTO::getProblemCode)</span><br><span class="line">  .filter(StringUtils::isNotEmpty).ifPresent(problemCode -&gt; &#123;</span><br><span class="line">            <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">                reqDTO.setProblemIndex(Integer.parseInt(reqDTO.getProblemCode()));</span><br><span class="line">            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApiException(ApiExceptionEnum.PARAMETER_ERROR, <span class="hljs-string">"problemCode 非法"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="hljs-comment">// 不用 Optional</span></span><br><span class="line"><span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(reqDTO.getProblemCode())) &#123;</span><br><span class="line">  <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">    reqDTO.setProblemIndex(Integer.parseInt(reqDTO.getProblemCode()));</span><br><span class="line">  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApiException(ApiExceptionEnum.PARAMETER_ERROR, <span class="hljs-string">"problemCode 非法"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 例子2</span></span><br><span class="line">Optional.ofNullable(problemCodeToMetrics.get(p.getProblemCode())).ifPresent(metrics -&gt; &#123;</span><br><span class="line">  p.setAcceptNum(metrics.getAcceptNum());</span><br><span class="line">  p.setSubmitNum(metrics.getSubmitNum());</span><br><span class="line">&#125;);</span><br><span class="line"><span class="hljs-comment">// 不用 Optional</span></span><br><span class="line">SubmissionMetricsDTO metrics = problemCodeToMetrics.get(p.getProblemCode());</span><br><span class="line"><span class="hljs-keyword">if</span> (metrics != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">  p.setAcceptNum(metrics.getAcceptNum());</span><br><span class="line">  p.setSubmitNum(metrics.getSubmitNum());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>第二种：可用可不用</li></ul><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 例子3</span></span><br><span class="line">Optional.ofNullable(redisPassword)</span><br><span class="line">  .filter(StringUtils::isNotEmpty)</span><br><span class="line">  .map(RedisPassword::of)</span><br><span class="line">  .ifPresent(configuration::setPassword);</span><br><span class="line"><span class="hljs-comment">// 不用 Optional</span></span><br><span class="line"><span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(redisPassword)) &#123;</span><br><span class="line">    configuration.setPassword(RedisPassword.of(redisPassword));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 例子4</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getMaxMemoryFactor</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> Optional.ofNullable(maxMemoryFactor).orElse(<span class="hljs-number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">// 不用 Optional</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getMaxMemoryFactor</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> maxMemoryFactor != <span class="hljs-keyword">null</span> ? maxMemoryFactor : <span class="hljs-number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 例子5</span></span><br><span class="line">Long userId = Optional.ofNullable(userSessionDTO).map(UserSessionDTO::getUserId).orElse(<span class="hljs-keyword">null</span>);</span><br><span class="line"><span class="hljs-comment">// 不用 Optional</span></span><br><span class="line">Long userId = userSessionDTO != <span class="hljs-keyword">null</span> ? userSessionDTO.getUserId() : <span class="hljs-keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 例子6</span></span><br><span class="line">Optional.ofNullable(reqDTO.getContestId())</span><br><span class="line">  .ifPresent(contestId -&gt; query.eq(SubmissionDO::getContestId, contestId));</span><br><span class="line"><span class="hljs-comment">// 不用 Optional</span></span><br><span class="line"><span class="hljs-keyword">if</span> (reqDTO.getContestId() != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">  query.eq(SubmissionDO::getContestId, reqDTO.getContestId());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 例子7</span></span><br><span class="line">String emailCode = Optional.ofNullable((String) redisUtils.get(redisKey)).orElseGet(() -&gt; CaptchaUtils.getRandomString(<span class="hljs-number">6</span>));</span><br><span class="line"><span class="hljs-comment">// 不用 Optional</span></span><br><span class="line">String emailCode = (String) redisUtils.get(redisKey);</span><br><span class="line"><span class="hljs-keyword">if</span> (emailCode == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">  emailCode = CaptchaUtils.getRandomString(<span class="hljs-number">6</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>第三种，用得有点别扭（乍一看挺爽，仔细想想又觉得代码可读性不太好）</li></ul><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 例子8（以前在公司看到的代码，已脱敏）</span></span><br><span class="line"><span class="hljs-keyword">boolean</span> oneBoolean = <span class="hljs-keyword">true</span>;</span><br><span class="line">Map&lt;String, String&gt; fMap = oneDTO.getFeatureMap();</span><br><span class="line"><span class="hljs-keyword">if</span> (fMap != <span class="hljs-keyword">null</span> &amp;&amp; fMap.containsKey(<span class="hljs-string">"oneKey"</span>) &amp;&amp; StringUtils.isNumeric(fMap.get(<span class="hljs-string">"oneKey"</span>))) &#123;</span><br><span class="line">    Long options = Long.valueOf(fMap.get(<span class="hljs-string">"oneKey"</span>));</span><br><span class="line">    <span class="hljs-keyword">if</span> (options != <span class="hljs-keyword">null</span> &amp;&amp; ((options&gt;&gt;&gt;<span class="hljs-number">48</span>) &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">1</span>) &#123;</span><br><span class="line">        <span class="hljs-comment">// 第48位为1，表示"一种特殊的含义"</span></span><br><span class="line">        oneBoolean = <span class="hljs-keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">// 假如改造成 Optional（且要求我只能用一条链式调用完成这个功能）</span></span><br><span class="line"><span class="hljs-keyword">boolean</span> oneBoolean = Optional.ofNullable(fulfillWareDTO.getFeatureMap())</span><br><span class="line">     .map(map -&gt; map.get(<span class="hljs-string">"oneKey"</span>))</span><br><span class="line">	.filter(StringUtils::isNumeric)</span><br><span class="line">     .map(Long::parseLong)</span><br><span class="line">     .map(options -&gt; ((options &gt;&gt;&gt; <span class="hljs-number">48</span>) &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>) <span class="hljs-comment">// 注意这里用的是反逻辑，十分不好理解</span></span><br><span class="line">     .orElse(<span class="hljs-keyword">true</span>);</span><br></pre></td></tr></table></figure><ul><li>第四种，这样用感觉还行</li></ul><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 例子9（以前在公司看到的代码）</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getSellerNick</span><span class="hljs-params">(String sellerId)</span></span>&#123;</span><br><span class="line">	<span class="hljs-keyword">if</span> (StringUtils.isEmpty(sellerId))&#123;</span><br><span class="line">	    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	Result&lt;UserDO&gt; result = userReadService.getUserByUserId(Long.valueOf(sellerId));</span><br><span class="line">	<span class="hljs-keyword">if</span> (result != <span class="hljs-keyword">null</span> &amp;&amp; result.isSuccess() &amp;&amp; result.getData() != <span class="hljs-keyword">null</span>)&#123;</span><br><span class="line">	    <span class="hljs-keyword">return</span> result.getData().getNick();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">// 假如改造成 Optional</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getSellerNick</span><span class="hljs-params">(String sellerId)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> Optional.ofNullable(sellerId)</span><br><span class="line">            .filter(StringUtils::isNumeric)</span><br><span class="line">            .map(Long::parseLong)</span><br><span class="line">            .map(sellerIdLong -&gt; userReadService.getUserByUserId(sellerIdLong))</span><br><span class="line">            .map(Result::getData)</span><br><span class="line">            .map(UserDO::getNick)</span><br><span class="line">            .orElse(<span class="hljs-keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 例子10，官方的例子</span></span><br><span class="line">String version = <span class="hljs-string">"UNKNOWN"</span>;</span><br><span class="line"><span class="hljs-keyword">if</span>(computer != <span class="hljs-keyword">null</span>)&#123;</span><br><span class="line">  Soundcard soundcard = computer.getSoundcard();</span><br><span class="line">  <span class="hljs-keyword">if</span>(soundcard != <span class="hljs-keyword">null</span>)&#123;</span><br><span class="line">    USB usb = soundcard.getUSB();</span><br><span class="line">    <span class="hljs-keyword">if</span>(usb != <span class="hljs-keyword">null</span>)&#123;</span><br><span class="line">      version = usb.getVersion();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">// 用 Optional（这种确实是值得使用的，可读性好）</span></span><br><span class="line">String name = Optional.ofNullable(computer)</span><br><span class="line">                          .map(Computer::getSoundcard)</span><br><span class="line">                          .map(Soundcard::getUSB)</span><br><span class="line">                          .map(USB::getVersion)</span><br><span class="line">                          .orElse(<span class="hljs-string">"UNKNOWN"</span>);</span><br><span class="line"><span class="hljs-comment">// 如果有 Kotlin 的空安全则更爽</span></span><br><span class="line">String version = computer?.getSoundcard()?.getUSB()?.getVersion() ?: <span class="hljs-string">"UNKNOWN"</span>;</span><br></pre></td></tr></table></figure><h3 id="性能？"><a href="#性能？" class="headerlink" title="性能？"></a>性能？</h3><p>如果你看过 Java8 写的 Lambda 代码的字节码就会发现，匿名函数、函数式方法，都变成了一个个 synthetic 关键字的方法，即是 Java 编译器在编译器生成的方法。</p><p>所以其实看起来调用很爽，但其实发生了更多的方法调用。上面例子中的 “可用可不用” 种类中，是基于编码角度及其可读性来评判的，但如果再加上一个考虑点 “性能”，则 “可用可不用” 种类的代码应该不要用 Optional，此时显然调用两次 getter 的代价比调 Lambda 小得多！</p><h3 id="null-自身语义？"><a href="#null-自身语义？" class="headerlink" title="null 自身语义？"></a>null 自身语义？</h3><p>有时候在设计技术方案的时候会发现，如果变量的每种可能值都代表一个语义，刚好设计失误，就会有语义不够用的情况，此时 null 可能表示 “无，没有，忽略，不作用” 也可能表示 “空值”。</p><p>下面举个例子：在使用 MyBatis-Plus 这个库的时候，有一种更新数据库中一行数据的接口方法</p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">BaseMapper</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">Mapper</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateById</span><span class="hljs-params">(@Param(Constants.ENTITY)</span> T entity)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>调用 <code>BaseMapper::updateById</code> 方法，将一个 entity 传进去，它将 entity 中 ID 属性作为 SQL 中 Where 条件，忽视所有值为 null 的字段，将非 null 字段的值作为更新后的新值，实现更新一行的操作</p></li><li><p>此时，如果我想让他帮我更新一个字段为 null，就没有办法仅仅通过这个方法来完成</p></li><li><p>因为 MyBatis-Plus 在设计的时候，给 null 赋值上了 “忽略，不作用” 的语义，而不是 “空值” 的语义（当然这是对的，不然写代码丢数据的风险就更高了）</p></li><li><p>所以可以看到，null 可以被赋予更多的语义（由于刻意的设计）</p></li></ul><p>再一个例子（假想的，每调研过业内该业务咋设计）：</p><ul><li>我想表示一个状态机，拿微信好友 relation 业务举例，用一个 int 来表示我和另一个好友的关系</li><li>如果数据库中暂不存在我和他 relation 行，则当作陌生人</li><li>如果我申请添加他好友，则 int=1，他通过/拒绝 int=2/3，通过后我删除他/他删除我 int=4,5，通过后我拉黑他/他拉黑我 int=6,7</li><li>如果是他申请的情况，则 int 分别为 8..14</li><li>…</li><li>此时如果 int 可空，则可用 int=null 表示陌生人（诶，但我也可以不这样设计，我设计 int 是不可空字段，且 int=0 表示陌生人，此时 relation 行不存在和 int=0 是等价的）</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我的建议是：</p><ul><li>最好不要用 Optional（甚至在编码时当它不存在），尤其当你是一个没有很多编码经验，没有代码强迫症，没有好的 code taste 的程序员时（你刚看到了，我在年轻的时候写出过多少 shit 代码）</li><li>如果你想用 Optional，最好在遇到我上述说到的第四种级别的场景中才用，并且只用到 local 代码中，不要去考虑设计到 field, parameter, return value 之类</li><li>时常警惕 NPE</li></ul><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://stackoverflow.com/questions/26327957/should-java-8-getters-return-optional-type" target="_blank" rel="noopener">https://stackoverflow.com/questions/26327957/should-java-8-getters-return-optional-type</a></li><li><a href="https://www.oracle.com/technical-resources/articles/java/java8-optional.html" target="_blank" rel="noopener">https://www.oracle.com/technical-resources/articles/java/java8-optional.html</a></li><li><a href="https://www.cnblogs.com/yuarvin/p/13555143.html" target="_blank" rel="noopener">https://www.cnblogs.com/yuarvin/p/13555143.html</a></li></ul></div><ul class="post-copyright"><li><strong>本文标题：</strong><a href="https://zhangt.top/CS/Java8-Optional/">Java8-Optional使用心得</a></li><li><strong>本文作者：</strong><a href="https://zhangt.top">ZhangT</a></li><li><strong>本文链接：</strong><a href="https://zhangt.top/CS/Java8-Optional/">https://zhangt.top/CS/Java8-Optional/</a></li><li><strong>发布时间：</strong>2022-10-03</li><li><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</li></ul><hr style="height:1px;margin:1rem 0"><div class="level is-size-7 is-uppercase"><div class="level-start"><div class="level-item"><i class="fas fa-tags has-text-grey"></i>&nbsp; <a class="has-link-grey -link" href="/tags/Java/">Java</a></div></div></div></div></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？投喂一下吧！ヾ(●´∀｀●)</h3><div class="buttons is-centered"><a class="button is-info donate"><span class="icon is-small"><i class="fab fa-alipay"></i> </span><span>支付宝</span><div class="qrcode"><img src="/images/alipay.jpg" alt="支付宝"></div></a></div></div></div><div class="card card-transparent"><div class="level post-navigation is-flex-wrap is-mobile"><div class="level-end"><a class="level level-item has-link-grey article-nav-next" href="/MUSIC/Music-Theory/"><span class="level-item">乐理/吉他-学习笔记</span> <i class="level-item fas fa-chevron-right"></i></a></div></div></div><div class="card"><div class="card-content"><h3 class="title is-5 has-text-weight-normal">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.min.js"></script><script>var gitalk=new Gitalk({clientID:"91f36240e98756fc091e",clientSecret:"20de2f4dadd54bc04ad8db6c1090fb00a9477ac4",id:"aa81361122750a9c4a7064fcc47a43d2",repo:"zhangt2333.github.io",owner:"zhangt2333",admin:"zhangt2333",createIssueManually:!1,distractionFreeMode:!1});gitalk.render("comment-container")</script></div></div></div><div class="column is-4-tablet is-4-desktop is-3-widescreen has-order-1 column-left"><div class="card widget"><div class="card-content"><nav class="level" style="margin-bottom:1rem"><div class="level-item has-text-centered"><div><img class="image is-96x96 has-mb-6" src="/images/avatar.png" alt="Zhang T"><p class="is-size-4 is-block">Zhang T</p><p class="is-size-6 is-block">感受我的感受</p><p class="is-size-6 is-flex is-flex-center has-text-grey"><i class="fas fa-map-marker-alt has-mr-7"></i> <span>Nanjing &lt;- Qingdao, China</span></p></div></div></nav><nav class="level menu-list is-mobile" style="margin-bottom:1rem"><div class="level-item has-text-centered is-marginless"><a href="/archives/"><p class="heading">文章</p><p class="title has-text-weight-normal">24</p></a></div><div class="level-item has-text-centered is-marginless"><a href="/categories/"><p class="heading">分类</p><p class="title has-text-weight-normal">5</p></a></div><div class="level-item has-text-centered is-marginless"><a href="/tags/"><p class="heading">标签</p><p class="title has-text-weight-normal">24</p></a></div></nav><div class="level"><a class="level-item button is-link is-rounded" href="https://github.com/zhangt2333" target="_blank"><i class="fab fa-github"></i>&nbsp;&nbsp;关注我</a></div></div></div><div class="card widget column-left is-sticky" id="toc"><div class="card-content"><div class="menu" style="max-height:750px;overflow:auto"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex" href="#引言"><span class="has-mr-6">1</span> <span>引言</span></a></li><li><a class="is-flex" href="#他人观点"><span class="has-mr-6">2</span> <span>他人观点</span></a></li><li><a class="is-flex" href="#公认事项"><span class="has-mr-6">3</span> <span>公认事项</span></a></li><li><a class="is-flex" href="#个人之言"><span class="has-mr-6">4</span> <span>个人之言</span></a><ul class="menu-list"><li><a class="is-flex" href="#不要为了用而用"><span class="has-mr-6">4.1</span> <span>不要为了用而用</span></a></li><li><a class="is-flex" href="#性能？"><span class="has-mr-6">4.2</span> <span>性能？</span></a></li><li><a class="is-flex" href="#null-自身语义？"><span class="has-mr-6">4.3</span> <span>null 自身语义？</span></a></li></ul></li><li><a class="is-flex" href="#总结"><span class="has-mr-6">5</span> <span>总结</span></a></li><li><a class="is-flex" href="#References"><span class="has-mr-6">6</span> <span>References</span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start has-text-centered-mobile"><a class="footer-logo is-block has-mb-6" href="/">TTTT&#39;s Blog</a><p class="is-size-7">&copy; 2022 ZhangT&nbsp; Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle"><p class="control"><a class="button is-white is-large" target="_blank" title="GitHub" href="https://github.com/zhangt2333"><i class="fab fa-github"></i></a></p><p class="control"><a class="button is-white is-large" target="_blank" title="E-mail" href="mailto:zhangt2333@gmail.com"><i class="fa fa-envelope-open"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:"unfolded"}}}</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script src="/js/gallery.js" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now</a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>document.addEventListener("DOMContentLoaded",function(){outdatedBrowser({bgColor:"#f25648",color:"#ffffff",lowerThan:"flex"})})</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><script>document.addEventListener("DOMContentLoaded",function(){MathJax.Hub.Config({"HTML-CSS":{matchFontHeight:!1},SVG:{matchFontHeight:!1},CommonHTML:{matchFontHeight:!1},skipTags:["script","noscript","style","textarea","pre","code"],processEscapes:!0,tex2jax:{inlineMath:[["$","$"]]}})})</script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back-to-top.js" defer></script><script src="/js/main.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..."> <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(无标题)"},CONTENT_URL:"/content.json"}</script><script src="/js/insight.js" defer></script><link rel="stylesheet" href="/css/search.css"><link rel="stylesheet" href="/css/insight.css"><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>